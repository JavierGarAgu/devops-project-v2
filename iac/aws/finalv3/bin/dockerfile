FROM amazonlinux:2

# Install tar (and other helpful utils)
RUN yum install -y tar gzip shadow-utils \
    && yum clean all

# Copy RPMs tar.gz into the image
COPY rpms.tar.gz /tmp/rpms.tar.gz

# Extract and install RPMs
RUN mkdir -p /tmp/rpms \
    && tar -xzf /tmp/rpms.tar.gz -C /tmp/rpms \
    && yum localinstall -y /tmp/rpms/*.rpm \
    && yum clean all \
    && rm -rf /tmp/rpms /tmp/rpms.tar.gz

# Add GitHub Actions Runner
RUN curl -o actions-runner.tar.gz -L https://github.com/actions/runner/releases/download/v2.316.1/actions-runner-linux-x64-2.316.1.tar.gz \
    && mkdir -p /actions-runner \
    && tar xzf actions-runner.tar.gz -C /actions-runner \
    && rm actions-runner.tar.gz

WORKDIR /actions-runner

# Copy the startup script
COPY start-runner.sh /actions-runner/start-runner.sh
RUN chmod +x /actions-runner/start-runner.sh
# Create a user for the runner
RUN useradd -m runner

# Make the /actions-runner directory owned by that user
RUN chown -R runner:runner /actions-runner

# Switch to the non-root user
USER runner
# Set the entrypoint
ENTRYPOINT ["/actions-runner/start-runner.sh"]

